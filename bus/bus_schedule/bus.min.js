"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}};var GLOBALVARS={"plugin_name":"bus.js","version":1.3,"finish":false,"all_ifbds":[]};var Dictionary=function(){function Dictionary(raw_data,default_lang){_classCallCheck(this,Dictionary);this._data=raw_data;this._defaultlang=default_lang}_createClass(Dictionary,[{key:"fetch",value:function fetch(lang){if(this._data[lang]==undefined){lang=this._defaultlang}return this._data[lang]}},{key:"data",get:function get(){return this._data},set:function set(d){var original=this._data;this._data=d;if(this._data[this._defaultlang]==undefined){this._data[this._defaultlang]=original}}}]);return Dictionary}();var _language_json={"zh-cn":{"_commingsoon":"正在驶来","_nminutesleft_prefix":"预计","_nminutesleft_postfix":"到达","_outage":"今日运营结束","_category":"班车类型：","_route":"行驶路线：","_lastupdate":"最后更新时间：","_businfo":"班车信息"}};$.ajax({url:'./language.json',success:function success(json){_language_json=JSON.parse(json)},dataType:"text",cache:true});var Infoboard={init:function init(container,data,isshowbusinfo,language){var _targettimecatcher=function _targettimecatcher(i){var str;var property=me.data.timetable[me.tableindex].schedule[i].property;if(property=='online')str=undefined;str=me.data.timetable[me.tableindex].schedule[i].time;str=new Date().Format('yyyy/MM/dd')+' '+str;var targettime=new Date(str);if(property=='accurate')return[targettime,targettime,0];else if(property=='estimate'){var estimate_delay=0;if(me.data.timetable[me.tableindex].schedule[i].hasOwnProperty('estimate-delay'))estimate_delay=me.data.timetable[me.tableindex].schedule[i]['estimate-delay'];else estimate_delay=me.data.timetable[me.tableindex]['estimate-delay'];var targettime_withdelay=new Date();targettime_withdelay.setTime(targettime.getTime()+60*1000*estimate_delay);return[targettime,targettime_withdelay,estimate_delay]}};var _timeshower=function _timeshower(begin_index){var currenttime=new Date();for(var i=begin_index;i<me.data.timetable[me.tableindex].schedule.length;++i){var currenttime=new Date();var tmp=_targettimecatcher(i);var targettime=tmp[0];var targettime_withdelay=tmp[1];var estimate_delay=tmp[2];if(currenttime.getTime()<targettime_withdelay.getTime()){var countdown=new Date();countdown.setTime(targettime.getTime()-currenttime.getTime());if(currenttime.getTime()>targettime.getTime())return[i,me.dic.fetch(me.language)._commingsoon,me.dic.fetch(me.language)._nminutesleft_prefix+targettime_withdelay.Format('hh:mm')+me.dic.fetch(me.language)._nminutesleft_postfix,estimate_delay,10000];elsereturn[i,countdown,targettime.Format('hh:mm'),estimate_delay,countdown.getTime()/ 60 /1000]}}return[i,me.dic.fetch(me.language)._outage,me.dic.fetch(me.language)._outage,undefined,undefined]};var _stringformatter=function _stringformatter(str){var extrafield=undefined;var minutesleft=undefined;var pattern0=/\{(.+?)\}/g;var pattern1=/\[(.+?)\]/g;var v=str.match(pattern0);for(var i=v.length-1;i>=0;i--){var text;var vname=v[i].replace('{','').replace('}','');var index=vname.match(pattern1);if(index!=null)index=index[0].replace('[','').replace(']','');else index='';vname=vname.replace(pattern1,'');var predefined=['_countdown','_nexttime'];if(vname[0]=='_'){if(index=='')index='auto';var result=_timeshower(me.currententry);text=result[predefined.indexOf(vname)+1];extrafield=result[0];minutesleft=result[4];if(predefined==1)minutesleft=1000;if(typeof text!='string')text=text.Format_(index);return[text,extrafield,minutesleft]}if(me.data.timetable[me.tableindex].hasOwnProperty(vname)){if(index!='')text=me.data.timetable[me.tableindex][vname][index].toString();else text=me.data.timetable[me.tableindex][vname].toString()}else if(me.data.hasOwnProperty(vname)){if(index!='')text=me.data[vname][index].toString();else text=me.data[vname].toString()}else{text=v}str=str.replace(v[i],text)}return[str,extrafield,minutesleft]};var _tableselector=function _tableselector(){var timetable=[];$.extend(timetable,me.data.timetable);for(var i=timetable.length-1;i>=0;i--){timetable[i]['_id']=i}timetable.sort(function(a,b){return b.priority-a.priority});for(var i=0;i<=timetable.length-1;i++){var f=timetable[i].filter[0];if(f(timetable[i].filter[1]))return timetable[i]._id;}return-1};var _switchlanguage=function _switchlanguage(dst_lang){if(dst_lang===undefined)return;if(dst_lang!==me.language){for(var key in me.dic.data){key=key.toLowerCase();if(key===dst_lang){me.language=key;break}}}if(dst_lang!=me.language){for(var key in me.dic){if(key.slice(0,2).toLowerCase()===dst_lang.slice(0,2)){me.language=key.toLowerCase();break}}}};var me={};me.container=container;me.expand=false;me.tag='_'+container.attr('id');me.data_static=null;me.data=data;if(me.data['version']>GLOBALVARS['version']){console.log('*** New version of bus.js is needed. ***');return undefined}me.language=language?language.toLowerCase():'zh-cn';me.dic=new Dictionary(_language_json,me.language);me.data_static=JSON.parse(JSON.stringify(me.data));me.data=preprocess(me.data);me.select_lang=function(dst_lang){var json=me.data_static;if(!json.hasOwnProperty('language')){return dst_lang}var src_lang=json.language.default.toLowerCase();dst_lang=dst_lang?dst_lang.toLowerCase():'auto';if(src_lang===dst_lang)return dst_lang;var avail_lang_list=new Array();for(var i=0;i<json.language.list.length;i++){avail_lang_list.push(json.language.list[i].name.toLowerCase())}avail_lang_list.push(src_lang);var nav_lang_list=navigator.languages?navigator.languages.map(function(m){return m.toLowerCase()}):[];var final_dst_lang_index=-1;if(dst_lang!='auto'){for(var i=0;i<avail_lang_list.length;i++){if(avail_lang_list[i]===dst_lang)final_dst_lang_index=i;else continue;break}if(final_dst_lang_index==-1){for(var i=0;i<avail_lang_list.length;i++){if(avail_lang_list[i].indexOf(dst_lang)!==-1)final_dst_lang_index=i;else if(avail_lang_list[i].slice(0,2)===dst_lang.slice(0,2))final_dst_lang_index=i;else continue;break}}}else{for(var i=0;i<nav_lang_list.length;i++){final_dst_lang_index=avail_lang_list.indexOf(nav_lang_list[i]);if(final_dst_lang_index!==-1)break}if(final_dst_lang_index===-1){for(var i=0;i<nav_lang_list.length;i++){for(var j=avail_lang_list.length-1;j>=0;j--){if(avail_lang_list[j].slice(0,2)===nav_lang_list[i].slice(0,2)){final_dst_lang_index=j;break}}if(final_dst_lang_index!=-1)break}}}if(final_dst_lang_index===-1){dst_lang=navigator.browserLanguage?navigator.browserLanguage.toLowerCase():navigator.language.toLowerCase();final_dst_lang_index=avail_lang_list.indexOf(dst_lang)}if(final_dst_lang_index===-1)return src_lang;if(final_dst_lang_index===avail_lang_list.length-1)return dst_lang;else dst_lang=json.language.list[final_dst_lang_index].name.toLowerCase();if(src_lang===dst_lang)return dst_lang;$.ajax({url:json.language.list[final_dst_lang_index].url,success:function success(json_ajax){var dictionary=JSON.parse(json_ajax);var inner_translate=function inner_translate(json){for(var prop in json){if(prop==='filter'||prop==='property'||prop==='language'||prop==='time')continue;if(typeof json[prop]==='string')json[prop]=dictionary[json[prop]]?dictionary[json[prop]]:json[prop];else if(_typeof(json[prop])==='object')for(var element in json[prop]){inner_translate(json[prop])}elsecontinue}};json=JSON.parse(JSON.stringify(me.data_static));preprocess(json);inner_translate(json);me.data=json;_switchlanguage(dst_lang);me.update(2);me.update(0);},dataType:"text",cache:true});return dst_lang};me.select_lang(language);me.tableindex=_tableselector();me.instant_buffer=[];me.daily_buffer=[];me.currententry=_timeshower(0)[0];me.update=function(mode){if(mode%10==1){me.container.children('div.Top-container').children('div.Progress-indicator').removeClass('warning-indicator');me.container.children('div.Top-container').children('div.Progress-indicator').removeClass('notice-indicator');for(var i=me.instant_buffer.length-1;i>=0;i--){var result=_stringformatter(me.instant_buffer.eq(i).attr('formatter'));me.instant_buffer.eq(i).text(result[0]);if(result[2]!=undefined){me.container.children('div.Top-container').children('div.Progress-indicator').attr('tag',result[3]);if(result[2]<2){me.container.children('div.Top-container').children('div.Progress-indicator').addClass('warning-indicator')}else if(result[2]<10){me.container.children('div.Top-container').children('div.Progress-indicator').addClass('notice-indicator')}}if(result[1]!=undefined){if(me.currententry!=result[1]){me.container.find('div#tabview'+me.tableindex+me.tag).find('div#i'+me.currententry).removeClass('highlight');me.container.find('div#tabview'+me.tableindex+me.tag).find('div#i'+me.currententry).addClass('lowlight');me.container.find('div#tabview'+me.tableindex+me.tag).find('div#i'+result[1]).addClass('highlight')}me.currententry=result[1]}}}else if(mode%10==0){for(var i=me.daily_buffer.length-1;i>=0;i--){var result=_stringformatter(me.daily_buffer.eq(i).attr('formatter'));me.daily_buffer.eq(i).text(result[0])}me.container.children('div.Top-container').children('div.Progress-indicator').removeClass('warning-indicator');me.container.children('div.Top-container').children('div.Progress-indicator').removeClass('notice-indicator');me.container.find().removeClass('highlight');me.container.find().removeClass('lowlight');me.container.find().removeClass('bolder');me.tableindex=_tableselector();me.currententry=_timeshower(0)[0];if(me.tableindex==-1)me.container.children('div.Bottom-container').find('a[href="#businfo'+me.tag+'"]').trigger('click').addClass('text-bold');else me.container.children('div.Bottom-container').find('a[href="#tabview'+me.tableindex+me.tag+'"]').trigger('click').addClass('text-bold');for(var i=0;i<me.currententry;i++){me.container.find('div#tabview'+me.tableindex+me.tag).find('div#i'+i).addClass('lowlight')}me.container.find('div#tabview'+me.tableindex+me.tag).find('div#i'+me.currententry).addClass('highlight');if(parseInt(mode/10)%10==1){var now=new Date();window.setTimeout(function(){global_update(10)},(86400-(now.getHours()*3600+now.getMinutes()*60+now.getSeconds()))*1000)}}else if(mode%10==2){var tablist=$('<ul class="nav nav-tabs" role="tablist"></ul>');var tabcontent=$('<div class="tab-content"></div>');for(var i=0;i<me.data.timetable.length;i++){var tabhref='tabview'+i;var tabname=me.data.timetable[i].title;var tab=$('<li role="presentation"><a href="#'+tabhref+me.tag+'" aria-controls="'+tabhref+me.tag+'" role="tab" data-toggle="tab">'+tabname+'</a></li>');tablist.append(tab);var tabpanel=$('<div role="tabpanel" class="tab-pane"></div>').attr('id',tabhref+me.tag);var whiteshadowbox=$('<div class="box-inner-shadow"></div>');var entriescontainer=$('<div class="Entries-container"></div>');for(var j=0;j<me.data.timetable[i].schedule.length;j++){var entry=$('<div class="Entry"></div>').attr('id','i'+j);var entrycenter=$('<div class="Entry-center"></div>');var entrytime=$('<div class="Entry-time"></div>');entrytime.text(me.data.timetable[i].schedule[j].time);entrycenter.append(entrytime);if(me.data.timetable[i].schedule[j].text!=undefined){var entrytext=$('<div class="Entry-text"></div>');entrytext.text(me.data.timetable[i].schedule[j].text);entrycenter.append(entrytext)}entry.append(entrycenter);entriescontainer.append(entry)}tabpanel.append(entriescontainer);tabcontent.append(tabpanel)}if(isshowbusinfo){var tab=$('<li role="presentation"><a href="#businfo'+me.tag+'" aria-controls="businfo'+me.tag+'" role="tab" data-toggle="tab">'+me.dic.fetch(me.language)._businfo+'</a></li>');var tabpanel=$('<div role="tabpanel" class="tab-pane"></div>').attr('id','businfo'+me.tag);var entriescontainer=$('<div class="Entries-container"></div>');var listgroup=$('<ul class="list-group padding"></ul>');listgroup.append($('<li class="list-group-item"></li>').text(me.dic.fetch(me.language)._category+me.data.name));listgroup.append($('<li class="list-group-item"></li>').text(me.dic.fetch(me.language)._route+me.data.route.join(" => ")));listgroup.append($('<li class="list-group-item"></li>').text(me.dic.fetch(me.language)._lastupdate+me.data.lastupdate));entriescontainer.append(listgroup);tablist.prepend(tab);tabpanel.append(entriescontainer);tabcontent.prepend(tabpanel)}me.container.children('div.Bottom-container').empty();me.container.children('div.Bottom-container').append(tablist).append(tabcontent)}};me.instant_buffer=me.container.children('div.Top-container').children('div[formatter*="{_"]');me.daily_buffer=me.container.children('div.Top-container').children().not('div[formatter*="{_"]');me.update(2);me.update(10);me.update(1);GLOBALVARS['all_ifbds'].push(me);return me}};function preprocess(json){for(var t=json.timetable.length-1;t>=0;t--){for(var s=json.timetable[t].schedule.length-1;s>=0;s--){if(typeof json.timetable[t].schedule[s]=='string'){var p={'time':json.timetable[t].schedule[s],'property':'accurate'};json.timetable[t].schedule[s]=p}if(json.timetable[t].schedule[s].hasOwnProperty('text')){if(typeof json.timetable[t].schedule[s].text=='number')json.timetable[t].schedule[s].text=json.timetable[t].text[json.timetable[t].schedule[s].text]}else{json.timetable[t].schedule[s].text=undefined}}json.timetable[t].filter=_datefilter(json.timetable[t].filter);}return json}function _datefilter(filter){var is_work_day=function is_work_day(date_str){var holidays_2018=new Array("2018/1/1","2018/2/15","2018/2/16","2018/2/17","2018/2/18","2018/2/19","2018/2/20","2018/2/21","2018/4/5","2018/4/6","2018/4/7","2018/4/29","2018/4/30","2018/5/1","2018/6/18","2018/9/24","2018/10/1","2018/10/2","2018/10/3","2018/10/4","2018/10/5","2018/10/6","2018/10/7");var ex_workdays_2018=new Array("2018/2/11","2018/2/24","2018/4/8","2018/4/28","2018/9/29","2018/9/30");var this_date;if(date_str==undefined)this_date=new Date();else this_date=new Date(date_str);date_str=this_date.getFullYear()+'/'+(this_date.getMonth()+1)+'/'+this_date.getDate();if(holidays_2018.indexOf(date_str)!=-1)return 2;if(ex_workdays_2018.indexOf(date_str)!=-1)return 0;if(this_date.getDay()==6||this_date.getDay()==0)return 1;else return 0};var _weekdayfilter=function _weekdayfilter(){return is_work_day()==0};var _holidayfilter=function _holidayfilter(){return!_weekdayfilter()};var _dayfilter=function _dayfilter(date){var d=new Date();date=date.toLowerCase();var day=['sun','mon','tue','thu','fri','sat'];if(day.indexOf(date)!=-1)d=day[d.getDay()];else d=d.getFullYear()+'/'+(d.getMonth()+1)+'/'+d.getDate();return date==d};var _mixedfilter=function _mixedfilter(list){var temp=false;for(var i=list.length-1;i>=0;i--){if(list[i]=='weekday')temp=_weekdayfilter();else if(list[i]=='holiday')temp=_holidayfilter();else if(typeof list[i]=='string')temp=_dayfilter(list[i]);else if(typeof list[i]=='function')temp=list[i]();if(temp)return true}return false};if(typeof filter=='function')return[filter,undefined];else if(typeof filter=='boolean')return[function(ret){return ret},filter];else if(filter=='weekday')return[_weekdayfilter,undefined];else if(filter=='holiday')return[_holidayfilter,undefined];else if(typeof filter=='string')return[_dayfilter,filter];else return[_mixedfilter,filter]};function global_update(mode){for(var i=GLOBALVARS['all_ifbds'].length-1;i>=0;i--){GLOBALVARS['all_ifbds'][i].update(mode)}}var now=new Date();var id=window.setInterval(function(){global_update(1)},1000);var id2=window.setTimeout(function(){global_update(0)},86400000-(now.getHours()*3600+now.getMinutes()*60+now.getSeconds())*1000);Date.prototype.Format_=function(fmt){if(fmt=='---:--')return this.getUTCHours()*60+this.getUTCMinutes()+':'+this.Format_('ss');else if(fmt=='auto')return(this.getUTCHours()==0?'':this.getUTCHours()+':')+this.Format_('mm:ss');var o={"M+":this.getUTCMonth()+1,"d+":this.getUTCDate(),"h+":this.getUTCHours(),"m+":this.getUTCMinutes(),"s+":this.getUTCSeconds(),"q+":Math.floor((this.getUTCMonth()+3)/ 3), //季度"S":this.getUTCMilliseconds()};if(/(y+)/.test(fmt))fmt=fmt.replace(RegExp.$1,(this.getUTCFullYear()+"").substr(4-RegExp.$1.length));for(var k in o){if(new RegExp("("+k+")").test(fmt))fmt=fmt.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}return fmt};Date.prototype.Format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/ 3), //季度"S":this.getMilliseconds()};if(/(y+)/.test(fmt))fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));for(var k in o){if(new RegExp("("+k+")").test(fmt))fmt=fmt.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}return fmt};